---
title: "ETC5242Assignment"
author: "Sahinya Akila"
date: "9/4/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
## Remove the line break in the file name!
churn_dat <- read_csv("https://raw.githubusercontent.com/square/pysurvival/master/pysurvival/datasets/churn.csv")
churn_dat <- churn_dat %>% filter(months_active > 0) %>% select(c(months_active, churned, company_size))
```


```{r}
km_curve <- function(time, event) {
  churn_data <- data.frame(time, event)
  
  km_data <- churn_data %>% 
  #filter(us_region == "West North Central") %>% 
  group_by(time,event) %>% 
  summarise(n = n()) %>% 
  mutate(count = ifelse(event == 1, sum(n), 0)) %>% 
  ungroup() %>% 
  mutate(accumulative=ifelse(event == 1, accumulate(count, `+`), 0)) %>% 
  ungroup() %>% 
  mutate(diff = ifelse(event == 1, nrow(churn_dat) - accumulative, 0)) %>% 
  mutate(count_status = ifelse(event == 1, n, 0),
         prod_risk = ifelse(diff == 0, 0, count_status/diff),
         survival=1-prod_risk,
         survival=ifelse(event == 1, 1-prod_risk, 1),
         prod_survival=ifelse(event == 1,accumulate(survival, `*`), 0)) %>% 
        filter(event == 1)
  
  return(km_data)
}

km_curve(churn_dat$months_active, churn_dat$churned) %>% 
  ggplot(aes(x=time,y=prod_survival)) + 
  geom_step()
```

