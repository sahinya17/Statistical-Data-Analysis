---
title: "ETC5242Assignment"
author: "Sahinya Akila"
date: "9/4/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
## Remove the line break in the file name!
churn_dat <- read_csv("https://raw.githubusercontent.com/square/pysurvival/master/pysurvival/datasets/churn.csv")
churn_dat <- churn_dat %>% filter(months_active > 0) %>% select(c(months_active, churned, company_size))
```

```{r}
km_model <- function(time, event){
  dataset <- data_frame(time, event)
  
  km_data <- dataset %>% 
    group_by(time, event) %>% 
    summarise(died = n()) %>% 
    ungroup() %>% 
    mutate(risk = nrow(dataset) - accumulate(died, `+`) + died) %>% 
    filter(event == 1) %>% 
    mutate(probability = 1 - died/risk,
           survival = accumulate(probability, `*`))
  return(km_data %>% select(time, survival))
}

km_survive <- km_model(churn_dat$months_active, churn_dat$churned) 

km_survive %>% 
  ggplot(aes(time, survival)) +
  geom_step()
```


```{r}
company_km_model <- data.frame(time = double(), survival = double(), company_size = character())
for(size in unique(churn_dat$company_size)){
  filtered <- churn_dat %>% filter(company_size == size)
  final_model <- km_model(filtered$months_active, filtered$churned) %>% mutate(company_size = size)
  company_km_model <- rbind(company_km_model, final_model)
}

company_km_model %>% 
  ggplot(aes(time, survival)) +
  geom_step() +
  facet_wrap(~company_size)
```


