---
title: "Statistical Thinking Assignment 2"
author: "Xinyi Cui, Janice Hsin Hsu, Pranali Angne, Sahinya Akila"
date: "10/17/2021"
output: pdf_document
---

\newpage

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
# Loading Libraries

library(printr)
library(tidyverse)
library(tidymodels)
library(broom)
library(splines)
library(dagitty)
library(ggdag)
```

# Task 1: Estimating Neonatal Mortality

## Introduction

One of this century’s global goals has been the reduction of childhood mortality across all countries. There has been enormous effort put into this goal at all levels from the united nations down to local interventions. The aim of this report is to produce a linear regression model to estimate the average neonatal mortality rate (NMR).

## Data

The source of the child mortality data is from the [UN Inter-agency Group for Child Mortality Estimation](https://childmortality.org/data).

It contains the following columns:

- `country_name`: Name of the country
- `year`: The year the data was measured
- `region`: The name of the continent the country is from
- `nmr`: The observed number of neonatal deaths per thousand live births (the neonatal mortality rate). This is measured either using a country’s vital registration system (births and deaths register) or using some sort of high-quality survey. 
- `u5mr`: The estimated under-five mortality rate
- `nmr_transformed`: log of the number of neonatal deaths per 1000 live births divided by the number of non-neonantal deaths per 1000 live births. 

$$log(\frac{nmr}{u5mr - nmr})$$
```{r}
# Reading the data
neonatal_mortality <- read_csv("neonatal_mortality.csv")

# Adding log ratio between neonatal mortality and non-neonatal mortality rate and time
nmr_data <- neonatal_mortality %>% 
  mutate(u5mr_log = log(u5mr), 
         transformed_nmr = log(nmr/(u5mr-nmr)),
         time = year - min(year))
```

## Task 1.1: Linear Regression

### Task 1.1.1: Explain the choice of variables in your model (you should not use country_name, if you use U5MR, you should use it on the log-scale!). In particular you should consider whether an interaction effect should be used.

```{r variable-choice, fig.width=15}

# Splitting the data
nmr_split <- initial_split(nmr_data, strata = region)
nmr_train <- training(nmr_split)
nmr_test <- testing(nmr_split)

# Choosing the variables by trying different combinations of variables
fit1 <- lm(transformed_nmr ~ u5mr_log + region + time, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "all")

fit2 <- lm(transformed_nmr ~ u5mr_log + region, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "u5mr_region")

fit3 <- lm(transformed_nmr ~ u5mr_log + time, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "u5mr_time")

fit4 <- lm(transformed_nmr ~ region + time, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "region_time")

fit5 <- lm(transformed_nmr ~ region, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "region")

fit6 <- lm(transformed_nmr ~ u5mr_log, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "u5mr")

fit7 <- lm(transformed_nmr ~ time, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "time")

# joining all the data frames and calculating the upper and lower values
full_model <- list(fit1, fit2, fit3, fit4, fit5, fit6, fit7) %>% 
  reduce(full_join) %>% 
  mutate(upper = estimate + 1.96 * std.error,
         lower = estimate - 1.96 * std.error)

full_model %>% ggplot(aes(estimate, y = model)) +
  geom_errorbar(aes(xmin = lower, xmax = upper, color = term)) +
  geom_vline(aes(xintercept = 0),
             linetype = "dashed",
             size = 1.2,
             color = "steel blue") +
  facet_wrap(.~term, scale = "free_x") +
  scale_y_discrete(limits = c("all", "u5mr_region", "u5mr_time", "region_time", "region", "u5mr", "time"))+ 
  theme(panel.background = element_rect(fill = "linen"), legend.position = "none", text = element_text(size=25))

```

```{r}

# understanding relationship between the variables
dagify(nmr ~ u5mr,
       nmr ~ time,
       nmr ~ Region,
       time ~ u5mr,
       Region ~ u5mr
       ) %>% 
  ggdag_adjust(node_size = 20) +
  theme_dag(legend.position = "none") 
  

# Fitting the model using the training data (with the interactive effect)
fit <- lm(transformed_nmr ~ u5mr_log + u5mr_log*region + u5mr_log*time, nmr_train)
summary(fit)
```

u5mr_log*region significant

```{r}
#Q1 part2
# all data
fit %>% 
  augment(data = nmr_train) %>% 
  ggplot(aes(x = u5mr_log, y= transformed_nmr)) +
  geom_point()+
  geom_line(aes(x = u5mr_log, y = .fitted), color = "blue")
  
```

```{r}
# different region
fit %>% 
  augment(data = nmr_train) %>% 
  ggplot(aes(x = u5mr_log, y= transformed_nmr)) +
  geom_point()+
  geom_line(aes(x = u5mr_log, y = .fitted), color = "blue")+
  facet_wrap(~region, scale = "free")
```

```{r}
# 3 countries
nmr_train %>% 
  count(country_name) %>% 
  top_n(3)
```

```{r}
# 3 countries
fit %>% augment(data = nmr_train) %>% 
  filter(country_name %in% c("Bangladesh", "Peru", "Senegal")) %>% 
  ggplot(aes(x = u5mr_log, y = transformed_nmr)) +
  geom_point() +
  geom_line(aes(x = u5mr_log, y = .fitted), color = "blue") +
  facet_wrap(~country_name, scales = "free")
```



```{r}
#Q1 part3
# estimate the root mean square error and absolute error 
lm_pred <- tibble(pred = predict(fit, A2_test))
lm_pred <- bind_cols(A2_test, lm_pred)
lm_pred %>% 
  metrics(truth = transformed_nmr,
          estimate = pred)
```

```{r}
#Q1 part 4 
# prediction
A2_PI <- as_tibble(predict(fit, A2_test, interval = "prediction")) %>% 
  bind_cols(lm_pred)

A2_PI %>% 
  ggplot(aes(x = u5mr_log, y = transformed_nmr))+
  geom_point()+
  geom_line(aes(y = lwr), linetype = "dashed")+
  geom_line(aes(y = upr), linetype = "dashed")
```

```{r}
#non-linear

fit_test <- lm(log(nmr) ~ t +u5mr_log +region +u5mr_log*t, data = nmr_train)

lm_pred_test <- tibble(pred = predict(fit_test, A2_test))

lm_pred_test <- bind_cols(A2_test, lm_pred_test)

```


```{r}
# all data
bb <- A2_PI <- as_tibble(predict(fit_test, A2_test, interval = "prediction")) %>% 
  bind_cols(lm_pred) %>% 
  mutate(n_lwr = exp(lwr),
         n_upr = exp(upr))

bb %>% 
  ggplot(aes(x = u5mr_log, y = nmr))+
  geom_point()+
  geom_line(aes(y = n_lwr), linetype = "dashed") +
  geom_line(aes(y = n_upr), linetype = "dashed")
```
```{r}
# by region
bb %>% 
  ggplot(aes(x = u5mr_log, y = nmr))+
  geom_point()+
  geom_line(aes(y = n_lwr), linetype = "dashed") +
  geom_line(aes(y = n_upr), linetype = "dashed")+
  facet_wrap(~ region, scale = "free")
```

```{r}
#non-linear variable

fit <- lm(transformed_nmr ~ u5mr_log + u5mr_log*region + u5mr_log*t, nmr_train)


ggplot(nmr_train)+
  geom_point(aes(x = u5mr_log, y = transformed_nmr))


fit_bs <- lm(transformed_nmr ~ bs(u5mr_log, df= 15) + u5mr_log*region + u5mr_log*t, data = nmr_train)
```

```{r}
# root mean sqaure error and mean absolute error

lm_pred_bs <- tibble(pred = predict(fit_bs, A2_test))

lm_pred_bs <- bind_cols(A2_test, lm_pred_bs)

lm_pred_bs %>% 
  metrics(truth = transformed_nmr,
          estimate = pred)

```

```{r}
fit_bs %>% 
  augment(data = nmr_train) %>% 
  ggplot(aes(x = u5mr_log, y = transformed_nmr)) +
  geom_point()+
  geom_line(aes(x = u5mr_log, y = .fitted), color = "blue")+
  facet_wrap(~ region, scale = "free")
```



```{r}
#cross validation

folds <- vfold_cv(A2, v= 20)

spec <- linear_reg() %>% 
  set_engine("lm")

fits_cv <- fit_resamples(spec,
                         transformed_nmr ~ bs(u5mr_log, df =15)+ bs(u5mr_log, df =15)*region + bs(u5mr_log, df =15)*t,
                         resamples = folds
)

# find mean
collect_metrics(fits_cv)
```










