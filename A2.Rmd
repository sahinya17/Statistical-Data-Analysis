---
title: "Statistical Thinking Assignment 2"
author: "Xinyi Cui, Janice Hsin Hsu, Pranali Angne, Sahinya Akila"
date: "10/17/2021"
output: pdf_document
---

\newpage

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
# Loading Libraries

library(printr)
library(tidyverse)
library(tidymodels)
library(broom)
library(splines)
library(dagitty)
library(ggdag)
library(knitr)
library(gtsummary)
library(kableExtra)
```

# Task 1: Estimating Neonatal Mortality

## Introduction

One of this century’s global goals has been the reduction of childhood mortality across all countries. There has been enormous effort put into this goal at all levels from the united nations down to local interventions. The aim of this report is to produce a linear regression model to estimate the average neonatal mortality rate (NMR).

## Data

The source of the child mortality data is from the [UN Inter-agency Group for Child Mortality Estimation](https://childmortality.org/data).

It contains the following columns:

- `country_name`: Name of the country
- `year`: The year the data was measured
- `region`: The name of the continent the country is from
- `nmr`: The observed number of neonatal deaths per thousand live births (the neonatal mortality rate). This is measured either using a country’s vital registration system (births and deaths register) or using some sort of high-quality survey. 
- `u5mr`: The estimated under-five mortality rate
- `nmr_transformed`: log of the number of neonatal deaths per 1000 live births divided by the number of non-neonantal deaths per 1000 live births. 

$$log(\frac{nmr}{u5mr - nmr})$$
```{r}
# Reading the data
neonatal_mortality <- read_csv("neonatal_mortality.csv")

# Adding log ratio between neonatal mortality and non-neonatal mortality rate and time
nmr_data <- neonatal_mortality %>% 
  mutate(u5mr_log = log(u5mr), 
         transformed_nmr = log(nmr/(u5mr-nmr)),
         time = year - min(year))
```

## Task 1.1: Linear Regression

### Task 1.1.1: Explain the choice of variables in your model (you should not use country_name, if you use U5MR, you should use it on the log-scale!). In particular you should consider whether an interaction effect should be used.

```{r variable-choice, fig.width=20, fig.height=15}

# Splitting the data
nmr_split <- initial_split(nmr_data, strata = region)
nmr_train <- training(nmr_split)
nmr_test <- testing(nmr_split)

# Choosing the variables by trying different combinations of variables
fit1 <- lm(transformed_nmr ~ u5mr_log + region + time, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "all")

fit2 <- lm(transformed_nmr ~ u5mr_log + region, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "u5mr_region")

fit3 <- lm(transformed_nmr ~ u5mr_log + time, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "u5mr_time")

fit4 <- lm(transformed_nmr ~ region + time, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "region_time")

fit5 <- lm(transformed_nmr ~ region, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "region")

fit6 <- lm(transformed_nmr ~ u5mr_log, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "u5mr")

fit7 <- lm(transformed_nmr ~ time, nmr_train) %>% 
  tidy() %>% 
  mutate(model = "time")

# joining all the data frames and calculating the upper and lower values
full_model <- list(fit1, fit2, fit3, fit4, fit5, fit6, fit7) %>% 
  reduce(full_join) %>% 
  mutate(upper = estimate + 1.96 * std.error,
         lower = estimate - 1.96 * std.error)

full_model %>% ggplot(aes(estimate, y = model)) +
  geom_errorbar(aes(xmin = lower, xmax = upper, color = term)) +
  geom_vline(aes(xintercept = 0),
             linetype = "dashed",
             size = 1.2,
             color = "steel blue") +
  facet_wrap(.~term, scale = "free_x") +
  scale_y_discrete(limits = c("all", "u5mr_region", "u5mr_time", "region_time", "region", "u5mr", "time"))+ 
  theme(panel.background = element_rect(fill = "linen"), legend.position = "none", text = element_text(size=25))

```

```{r, fig.width=5, fig.height=5}

# understanding relationship between the variables
dagify(nmr ~ u5mr,
       nmr ~ time,
       nmr ~ Region,
       time ~ u5mr,
       Region ~ u5mr
       ) %>% 
  ggdag_adjust(node_size = 20) +
  theme_dag(legend.position = "none") 
  

# Fitting the model using the training data (with the interactive effect)
fit <- lm(transformed_nmr ~ u5mr_log + u5mr_log*region + u5mr_log*time, nmr_train)

summary(fit)
```

u5mr_log*region significant

### Task 1.1.2: Assess your linear model and comment on its fit. This should be done a) for all data simultaneously; b)for data in each region; and c) for data in a maximum of 3 countries that should be chosen to highlight different aspects of the fit diagnostics.

```{r, fig.width=8}
augment_fit <- fit %>% 
  augment(data = nmr_train)
# part a
augment_fit %>% 
  ggplot() +
  geom_point(aes(x = u5mr_log, y= transformed_nmr), color = "#1b9ce3")+
  geom_line(aes(x = u5mr_log, y = .fitted), color = "#ffda85") +
  theme(panel.background = element_rect(fill = "#cae6da"), text = element_text(size=15)) +
  xlab("Under 5 mortality rate in Log scale") +
  ylab("Neonatal Mortality Rate in Log Scale")
  
```

```{r, fig.width=20, fig.height=15}
# part b
augment_fit %>% 
  ggplot() +
  geom_point(aes(x = u5mr_log, y= transformed_nmr), color = "#7c9154")+
  geom_line(aes(x = u5mr_log, y = .fitted), color = "#ffda85")+
  facet_wrap(~region, scale = "free") +
  theme(panel.background = element_rect(fill = "#f0fcfc"), text = element_text(size=25)) +
  xlab("Under 5 mortality rate in Log scale") +
  ylab("Neonatal Mortality Rate in Log Scale")
```










